---
- hosts: all
  tasks:
    - name: Debug S3 configuration
      debug:
        msg: |
          S3 Endpoint: {{ zuul_log_targets.upload_logs_s3_endpoint | default('NOT DEFINED') }}
          Bucket: {{ zuul_log_targets.zuul_log_bucket | default('NOT DEFINED') }}
          Access Key: {{ zuul_log_targets.zuul_log_aws_access_key | default('NOT DEFINED') }}
          Secret Key: {{ zuul_log_targets.zuul_log_aws_secret_key | length | default('NOT DEFINED') }} characters
          Create Indexes: {{ zuul_log_targets.zuul_log_create_indexes | default('NOT DEFINED') }}
          Bucket Public: {{ zuul_log_targets.zuul_log_bucket_public | default('NOT DEFINED') }}
          Addressing Style: {{ zuul_log_targets.upload_logs_s3_addressing_style | default('NOT DEFINED') }}

    - name: Check for log directories
      shell: |
        echo "=== Checking common log directories ==="
        ls -la /var/log/zuul/ 2>/dev/null || echo "No /var/log/zuul directory"
        ls -la /srv/logs/ 2>/dev/null || echo "No /srv/logs directory"
        ls -la /tmp/ 2>/dev/null | grep -E "(log|zuul)" || echo "No log files in /tmp"
        echo "=== Current working directory ==="
        pwd
        ls -la
        echo "=== Environment variables ==="
        env | grep -i log || echo "No LOG environment variables"
      register: log_dirs_check
      no_log: false

    - name: Show log directories
      debug:
        msg: "{{ log_dirs_check.stdout_lines }}"

    - name: Test S3 connection manually
      shell: |
        python3 -c "
        import boto3
        from botocore.exceptions import ClientError
        
        try:
            s3 = boto3.client(
                's3',
                endpoint_url='{{ zuul_log_targets.upload_logs_s3_endpoint | default("https://minio-api.teim.app") }}',
                aws_access_key_id='{{ zuul_log_targets.zuul_log_aws_access_key | default("zuul-upload") }}',
                aws_secret_access_key='{{ zuul_log_targets.zuul_log_aws_secret_key | default("") }}',
                region_name='us-east-1'
            )
            print('S3 client created successfully')
            
            # Test bucket access
            response = s3.list_buckets()
            print('Available buckets:', [bucket['Name'] for bucket in response['Buckets']])
            
            # Test specific bucket
            response = s3.head_bucket(Bucket='{{ zuul_log_targets.zuul_log_bucket | default("zuul-logs") }}')
            print('Bucket {{ zuul_log_targets.zuul_log_bucket | default("zuul-logs") }} is accessible')
            
        except ClientError as e:
            print('S3 Error:', e)
        except Exception as e:
            print('General Error:', e)
        "
      register: s3_test_result
      no_log: false

    - name: Show S3 test result
      debug:
        msg: "{{ s3_test_result.stdout_lines }}"

    - name: Test file upload
      shell: |
        echo "Test log content" > /tmp/test-log.txt
        python3 -c "
        import boto3
        from botocore.exceptions import ClientError
        
        try:
            s3 = boto3.client(
                's3',
                endpoint_url='{{ zuul_log_targets.upload_logs_s3_endpoint | default("https://minio-api.teim.app") }}',
                aws_access_key_id='{{ zuul_log_targets.zuul_log_aws_access_key | default("zuul-upload") }}',
                aws_secret_access_key='{{ zuul_log_targets.zuul_log_aws_secret_key | default("") }}',
                region_name='us-east-1'
            )
            
            # Upload test file
            s3.upload_file('/tmp/test-log.txt', '{{ zuul_log_targets.zuul_log_bucket | default("zuul-logs") }}', 'test-upload.txt')
            print('Test file uploaded successfully')
            
            # List objects in bucket
            response = s3.list_objects_v2(Bucket='{{ zuul_log_targets.zuul_log_bucket | default("zuul-logs") }}')
            if 'Contents' in response:
                print('Objects in bucket:', [obj['Key'] for obj in response['Contents']])
            else:
                print('Bucket is empty')
                
        except ClientError as e:
            print('S3 Error:', e)
        except Exception as e:
            print('General Error:', e)
        "
      register: upload_test_result
      no_log: false

    - name: Show upload test result
      debug:
        msg: "{{ upload_test_result.stdout_lines }}"

    - name: Call original upload-logs-s3 role (for comparison)
      include_role:
        name: upload-logs-s3
      vars:
        upload_logs_s3_endpoint: "{{ zuul_log_targets.upload_logs_s3_endpoint | default('https://minio-api.teim.app') }}"
        zuul_log_bucket: "{{ zuul_log_targets.zuul_log_bucket | default('zuul-logs') }}"
        zuul_log_aws_access_key: "{{ zuul_log_targets.zuul_log_aws_access_key | default('zuul-upload') }}"
        zuul_log_aws_secret_key: "{{ zuul_log_targets.zuul_log_aws_secret_key | default('') }}"
        zuul_log_create_indexes: "{{ zuul_log_targets.zuul_log_create_indexes | default(true) }}"
        zuul_log_bucket_public: "{{ zuul_log_targets.zuul_log_bucket_public | default(true) }}"
        upload_logs_s3_addressing_style: "{{ zuul_log_targets.upload_logs_s3_addressing_style | default('path') }}"
      ignore_errors: true
